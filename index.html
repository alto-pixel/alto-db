<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messagerie Avanc√©e</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #3b82f6;
      --primary-dark: #1e40af;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border: #334155;
      --message-user: #1e3a8a;
      --message-other: #1f2937;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, #1a1f3a 100%);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }

    .app-container {
      display: grid;
      grid-template-columns: 320px 1fr;
      height: 100vh;
      gap: 0;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      animation: slideInLeft 0.5s ease-out;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.95em;
      color: white;
      flex-shrink: 0;
    }

    .avatar.group {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .user-details h3 {
      font-size: 0.95em;
      margin-bottom: 2px;
      font-weight: 600;
    }

    .user-details small {
      color: var(--text-secondary);
      font-size: 0.8em;
    }

    .logout-btn {
      width: 100%;
      padding: 10px;
      background: var(--danger);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 0.85em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #dc2626;
      transform: translateY(-2px);
    }

    .conversations-header {
      padding: 15px 20px;
      display: flex;
      gap: 10px;
    }

    .btn-new-conv {
      flex: 1;
      padding: 8px 12px;
      background: var(--primary);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }

    .btn-new-conv:hover {
      background: var(--primary-dark);
      transform: scale(1.02);
    }

    .search-box {
      padding: 10px 15px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.9em;
      margin: 0 15px 10px;
    }

    .conversations-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .conversation-item {
      padding: 12px;
      margin-bottom: 8px;
      background: var(--bg-tertiary);
      border: 2px solid transparent;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
    }

    .conversation-item:hover {
      background: var(--bg);
      border-color: var(--primary);
      transform: translateX(5px);
    }

    .conversation-item.active {
      background: var(--primary);
      border-color: var(--primary);
    }

    .conversation-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981, #059669);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9em;
      color: white;
      flex-shrink: 0;
      position: relative;
    }

    .conversation-avatar.group {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .online-indicator {
      width: 10px;
      height: 10px;
      background: var(--success);
      border-radius: 50%;
      position: absolute;
      bottom: 0;
      right: 0;
      border: 2px solid var(--bg-secondary);
    }

    .conversation-info {
      flex: 1;
      min-width: 0;
    }

    .conversation-name {
      font-size: 0.95em;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-preview {
      font-size: 0.8em;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }

    .unread-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      background: var(--danger);
      border-radius: 50%;
      font-size: 0.7em;
      font-weight: 700;
      flex-shrink: 0;
    }

    /* ===== MAIN CHAT ===== */
    .main-content {
      display: flex;
      flex-direction: column;
      background: var(--bg);
      height: 100%;
      overflow: hidden;
    }

    .chat-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-secondary);
      flex-shrink: 0;
    }

    .chat-header-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-title-group {
      display: flex;
      flex-direction: column;
    }

    .chat-title {
      font-size: 1.1em;
      font-weight: 600;
    }

    .chat-status {
      font-size: 0.8em;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      background: var(--success);
      border-radius: 50%;
    }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      text-align: center;
      padding: 40px;
    }

    .empty-state h2 {
      font-size: 1.5em;
      margin-bottom: 10px;
      color: var(--text);
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }

    .message-group {
      display: flex;
      gap: 12px;
      margin-bottom: 8px;
      animation: fadeInUp 0.3s ease-out;
    }

    .message-group.own {
      justify-content: flex-end;
    }

    .message-group.other {
      justify-content: flex-start;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8em;
      font-weight: bold;
      color: white;
      flex-shrink: 0;
    }

    .message-group.own .message-avatar {
      display: none;
    }

    .message-bubble {
      max-width: 55%;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .message-content {
      padding: 12px 16px;
      border-radius: 12px;
      word-wrap: break-word;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .message-group.own .message-content {
      background: var(--message-user);
      border-bottom-right-radius: 4px;
    }

    .message-group.other .message-content {
      background: var(--message-other);
      border-bottom-left-radius: 4px;
    }

    .message-text {
      font-size: 0.95em;
      line-height: 1.4;
    }

    .message-sender {
      font-size: 0.75em;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .message-time {
      font-size: 0.75em;
      color: rgba(255, 255, 255, 0.6);
    }

    .message-reactions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .reaction {
      background: var(--bg-tertiary);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .reaction:hover {
      background: var(--border);
      transform: scale(1.1);
    }

    .reaction-count {
      font-size: 0.7em;
      color: var(--text-secondary);
    }

    .message-actions {
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .message-group.own:hover .message-actions {
      opacity: 1;
    }

    .btn-action {
      width: 24px;
      height: 24px;
      border: none;
      background: var(--bg-tertiary);
      color: var(--text);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
      transition: all 0.2s ease;
    }

    .btn-action:hover {
      background: var(--danger);
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-secondary);
      font-size: 0.9em;
      margin: 10px 0;
      padding: 0 20px;
    }

    .typing-dots {
      display: flex;
      gap: 3px;
    }

    .dot {
      width: 6px;
      height: 6px;
      background: currentColor;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% { opacity: 0.3; }
      30% { opacity: 1; }
    }

    .input-area {
      padding: 20px;
      border-top: 1px solid var(--border);
      background: var(--bg-secondary);
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-shrink: 0;
    }

    .input-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message-input {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.95em;
      font-family: inherit;
      resize: none;
      max-height: 100px;
      transition: all 0.3s ease;
    }

    .message-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .send-btn, .emoji-btn {
      padding: 12px 20px;
      background: var(--primary);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .send-btn:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .emoji-btn {
      background: var(--bg-tertiary);
      color: var(--text);
      width: 44px;
      padding: 0;
    }

    .emoji-btn:hover {
      background: var(--border);
    }

    /* ===== EMOJI PICKER ===== */
    .emoji-picker {
      position: absolute;
      bottom: 60px;
      right: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      z-index: 100;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease-out;
    }

    .emoji-option {
      font-size: 1.5em;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .emoji-option:hover {
      transform: scale(1.2);
    }

    .hidden {
      display: none !important;
    }

    /* ===== AUTH ===== */
    .auth-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      padding: 20px;
    }

    .auth-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 40px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.6s ease-out;
    }

    .auth-card h1 {
      font-size: 1.8em;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.9em;
      color: var(--text-secondary);
      font-weight: 500;
    }

    input[type="email"],
    input[type="password"],
    input[type="text"] {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.95em;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .auth-buttons {
      display: flex;
      gap: 10px;
      margin-top: 24px;
    }

    .auth-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.95em;
    }

    .auth-btn-primary {
      background: var(--primary);
      color: white;
    }

    .auth-btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .auth-btn-secondary {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .auth-btn-secondary:hover {
      background: var(--border);
    }

    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--danger);
      color: #fca5a5;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.9em;
      animation: slideDown 0.3s ease-out;
    }

    .success-message {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--success);
      color: #86efac;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.9em;
    }

    /* ===== MODAL ===== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 30px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease-out;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-content h2 {
      margin-bottom: 20px;
      color: var(--text);
      font-size: 1.3em;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-btn-primary {
      background: var(--primary);
      color: white;
    }

    .modal-btn-secondary {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
    }

    .member-list {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
      max-height: 200px;
      overflow-y: auto;
    }

    .member-item {
      padding: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      background: var(--bg-tertiary);
      border-radius: 6px;
    }

    .member-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75em;
      color: white;
      flex-shrink: 0;
    }

    /* ===== ANIMATIONS ===== */
    @keyframes slideInLeft {
      from { transform: translateX(-320px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes fadeInUp {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes slideDown {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ===== SCROLLBAR ===== */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .app-container {
        grid-template-columns: 1fr;
      }

      .sidebar {
        display: none;
      }

      .message-bubble {
        max-width: 85%;
      }
    }
  </style>
</head>
<body>

<!-- Auth Screen -->
<div id="authScreen" class="auth-container">
  <div class="auth-card">
    <h1>üí¨ Chat Pro</h1>
    <p id="authSubtitle">Connectez-vous pour discuter</p>
    
    <div id="authError"></div>

    <div class="form-group">
      <label for="email">Email</label>
      <input type="email" id="email" placeholder="vous@exemple.com">
    </div>

    <div class="form-group">
      <label for="password">Mot de passe</label>
      <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>

    <div class="form-group" id="displayNameGroup" style="display:none;">
      <label for="displayName">Nom d'affichage</label>
      <input type="text" id="displayName" placeholder="Votre nom">
    </div>

    <div class="auth-buttons">
      <button class="auth-btn auth-btn-secondary" id="toggleAuth">Cr√©er un compte</button>
      <button class="auth-btn auth-btn-primary" id="authSubmit">Se connecter</button>
    </div>
  </div>
</div>

<!-- Chat App -->
<div id="chatApp" class="app-container" style="display:none;">
  
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="user-info">
        <div class="avatar" id="userAvatar">A</div>
        <div class="user-details">
          <h3 id="userName">Utilisateur</h3>
          <small>‚úì En ligne</small>
        </div>
      </div>
      <button class="logout-btn" id="logoutBtn">D√©connexion</button>
    </div>

    <div class="conversations-header">
      <button class="btn-new-conv" id="newConversationBtn" title="Nouvelle conversation">
        <i class="fas fa-plus"></i> 1-to-1
      </button>
      <button class="btn-new-conv" id="newGroupBtn" title="Nouveau groupe" style="flex:0.8;">
        <i class="fas fa-users"></i> Groupe
      </button>
    </div>

    <input type="text" class="search-box" id="searchConversations" placeholder="üîç Chercher...">

    <div class="conversations-list" id="conversationsList">
      <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
        Aucune conversation
      </div>
    </div>
  </div>

  <!-- Main Chat -->
  <div class="main-content">
    <div id="noConversationSelected" class="empty-state">
      <h2>üëã Bienvenue!</h2>
      <p>S√©lectionnez une conversation ou cr√©ez-en une nouvelle</p>
    </div>

    <div id="chatWindow" style="display:none; display:flex; flex-direction:column;">
      <div class="chat-header">
        <div class="chat-header-info">
          <div class="avatar" id="chatAvatar">A</div>
          <div class="chat-title-group">
            <div class="chat-title" id="chatTitle">Conversation</div>
            <div class="chat-status" id="chatStatus">
              <span class="status-dot"></span>
              <span id="statusText">En ligne</span>
            </div>
          </div>
        </div>
        <button id="infoBtn" style="background: none; border: none; color: var(--text); cursor: pointer; font-size: 1.2em;">
          <i class="fas fa-info-circle"></i>
        </button>
      </div>

      <div class="messages-container" id="messagesContainer"></div>

      <div class="input-area">
        <div class="input-wrapper">
          <textarea class="message-input" id="messageInput" placeholder="√âcrivez un message..." rows="1"></textarea>
        </div>
        <button class="emoji-btn" id="emojiBtn" title="R√©actions">
          <i class="fas fa-smile"></i>
        </button>
        <button class="send-btn" id="sendBtn">Envoyer</button>
      </div>
    </div>
  </div>

  <!-- Emoji Picker -->
  <div class="emoji-picker hidden" id="emojiPicker">
    <div class="emoji-option" data-emoji="üëç">üëç</div>
    <div class="emoji-option" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</div>
    <div class="emoji-option" data-emoji="üòÇ">üòÇ</div>
    <div class="emoji-option" data-emoji="üéâ">üéâ</div>
    <div class="emoji-option" data-emoji="üî•">üî•</div>
    <div class="emoji-option" data-emoji="üòç">üòç</div>
    <div class="emoji-option" data-emoji="üò±">üò±</div>
    <div class="emoji-option" data-emoji="ü§î">ü§î</div>
    <div class="emoji-option" data-emoji="üò¥">üò¥</div>
    <div class="emoji-option" data-emoji="üíØ">üíØ</div>
  </div>
</div>

<!-- Modal Nouvelle Conversation (1-to-1) -->
<div id="newConversationModal" class="modal">
  <div class="modal-content">
    <h2>üí¨ Nouvelle conversation</h2>
    <div class="form-group">
      <label for="recipientEmail">Email du destinataire</label>
      <input type="email" id="recipientEmail" placeholder="ami@exemple.com">
    </div>
    <div id="conversationError"></div>
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-secondary" id="cancelConversation">Annuler</button>
      <button class="modal-btn modal-btn-primary" id="createConversationBtn">Cr√©er</button>
    </div>
  </div>
</div>

<!-- Modal Nouveau Groupe -->
<div id="newGroupModal" class="modal">
  <div class="modal-content">
    <h2>üë• Nouveau groupe</h2>
    <div class="form-group">
      <label for="groupName">Nom du groupe</label>
      <input type="text" id="groupName" placeholder="Nom du groupe">
    </div>
    <div class="form-group">
      <label>Membres (Email)</label>
      <div id="membersList" class="member-list"></div>
      <input type="email" id="memberEmail" placeholder="Ajouter un membre..." style="margin-top: 10px;">
      <button id="addMemberBtn" style="width: 100%; margin-top: 8px; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">Ajouter</button>
    </div>
    <div id="groupError"></div>
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-secondary" id="cancelGroup">Annuler</button>
      <button class="modal-btn modal-btn-primary" id="createGroupBtn">Cr√©er le groupe</button>
    </div>
  </div>
</div>

<!-- Modal Infos Groupe -->
<div id="groupInfoModal" class="modal">
  <div class="modal-content">
    <h2 id="groupInfoTitle">Infos du groupe</h2>
    <div id="groupInfoMembers"></div>
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-secondary" id="closeGroupInfo">Fermer</button>
    </div>
  </div>
</div>

<script>
  // ===== CONFIG =====
  const SUPABASE_URL = 'https://nwwuolbafiacxcqtkuri.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_XGosWkveljvqaqSYuLEuMQ_b-otnH9b';

  const REACTION_EMOJIS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üéâ', 'üî•', 'üòç', 'üò±', 'ü§î', 'üò¥', 'üíØ'];

  let supabaseClient = null;
  let currentUser = null;
  let currentConversation = null;
  let messageSubscription = null;
  let typingTimeout = null;
  let isSignUpMode = false;
  let selectedMembers = [];

  // Initialisation
  document.addEventListener('DOMContentLoaded', initApp);

  async function initApp() {
    if (SUPABASE_URL === 'https://YOUR_URL.supabase.co' || SUPABASE_KEY === 'YOUR_KEY') {
      showError('authError', '‚öôÔ∏è Configurez vos credentials Supabase');
      return;
    }

    try {
      const { createClient } = window.supabase;
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

      // Event listeners
      document.getElementById('toggleAuth').addEventListener('click', toggleAuthMode);
      document.getElementById('authSubmit').addEventListener('click', handleAuth);
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('newConversationBtn').addEventListener('click', () => openModal('newConversationModal'));
      document.getElementById('newGroupBtn').addEventListener('click', () => openModal('newGroupModal'));
      document.getElementById('cancelConversation').addEventListener('click', () => closeModal('newConversationModal'));
      document.getElementById('cancelGroup').addEventListener('click', () => closeModal('newGroupModal'));
      document.getElementById('createConversationBtn').addEventListener('click', createConversation);
      document.getElementById('createGroupBtn').addEventListener('click', createGroup);
      document.getElementById('addMemberBtn').addEventListener('click', addGroupMember);
      document.getElementById('closeGroupInfo').addEventListener('click', () => closeModal('groupInfoModal'));
      document.getElementById('infoBtn').addEventListener('click', showGroupInfo);
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      document.getElementById('emojiBtn').addEventListener('click', toggleEmojiPicker);
      document.getElementById('messageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      document.getElementById('messageInput').addEventListener('input', onTyping);
      document.getElementById('searchConversations').addEventListener('input', filterConversations);

      // Emoji picker
      document.querySelectorAll('.emoji-option').forEach(opt => {
        opt.addEventListener('click', (e) => {
          addReaction(e.target.dataset.emoji);
          toggleEmojiPicker();
        });
      });

      // V√©rifier si utilisateur connect√©
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (user) {
        currentUser = user;
        loadChatApp();
      }
    } catch (error) {
      showError('authError', 'Erreur: ' + error.message);
    }
  }

  async function handleAuth() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const displayName = document.getElementById('displayName').value.trim();

    if (!email || !password) {
      showError('authError', 'Email et mot de passe requis');
      return;
    }

    if (isSignUpMode && !displayName) {
      showError('authError', 'Nom d\'affichage requis');
      return;
    }

    try {
      let result;
      
      if (isSignUpMode) {
        result = await supabaseClient.auth.signUp({ email, password });
        if (result.error) throw result.error;
        
        const { error: profileError } = await supabaseClient
          .from('user_profiles')
          .insert([{ id: result.data.user.id, email, display_name: displayName }]);

        if (profileError) throw profileError;

        showSuccess('authError', 'Compte cr√©√© ! Connectez-vous.');
        toggleAuthMode();
      } else {
        result = await supabaseClient.auth.signInWithPassword({ email, password });
        if (result.error) throw result.error;

        currentUser = result.data.user;
        loadChatApp();
      }
    } catch (error) {
      showError('authError', error.message);
    }
  }

  function toggleAuthMode() {
    isSignUpMode = !isSignUpMode;
    const btn = document.getElementById('toggleAuth');
    const submit = document.getElementById('authSubmit');
    const group = document.getElementById('displayNameGroup');

    if (isSignUpMode) {
      btn.textContent = 'Se connecter';
      submit.textContent = 'Cr√©er un compte';
      group.style.display = 'block';
      document.getElementById('authSubtitle').textContent = 'Cr√©ez un nouveau compte';
    } else {
      btn.textContent = 'Cr√©er un compte';
      submit.textContent = 'Se connecter';
      group.style.display = 'none';
      document.getElementById('authSubtitle').textContent = 'Connectez-vous pour discuter';
    }
    document.getElementById('authError').innerHTML = '';
  }

  async function logout() {
    try {
      await supabaseClient.auth.signOut();
      currentUser = null;
      currentConversation = null;
      selectedMembers = [];
      document.getElementById('authScreen').style.display = 'flex';
      document.getElementById('chatApp').style.display = 'none';
      if (messageSubscription) await messageSubscription.unsubscribe();
    } catch (error) {
      console.error('Erreur:', error);
    }
  }

  async function loadChatApp() {
    try {
      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('chatApp').style.display = 'grid';

      const { data: profile } = await supabaseClient
        .from('user_profiles')
        .select('*')
        .eq('id', currentUser.id)
        .single();

      if (profile) {
        document.getElementById('userName').textContent = profile.display_name;
        document.getElementById('userAvatar').textContent = profile.display_name?.charAt(0).toUpperCase();
      }

      loadConversations();
    } catch (error) {
      console.error('Erreur:', error);
    }
  }

  async function loadConversations() {
    try {
      // 1. R√©cup√©rer les conversations o√π l'utilisateur est participant
      const { data: conversations, error: convError } = await supabaseClient
        .from('conversations')
        .select(`
          id,
          name,
          is_group,
          created_at,
          updated_at
        `)
        .order('updated_at', { ascending: false });

      if (convError) {
        console.error('Erreur chargement conversations:', convError);
        return;
      }

      if (!conversations || conversations.length === 0) {
        document.getElementById('conversationsList').innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucune conversation</div>';
        return;
      }

      // 2. Pour chaque conversation, r√©cup√©rer les infos
      const conversationsWithDetails = await Promise.all(
        conversations.map(async (conv) => {
          const { data: members } = await supabaseClient
            .from('conversation_members')
            .select('user_id, user:user_profiles(id, display_name)')
            .eq('conversation_id', conv.id);

          const { data: lastMsg } = await supabaseClient
            .from('messages')
            .select('content, created_at, sender_id')
            .eq('conversation_id', conv.id)
            .order('created_at', { ascending: false })
            .limit(1);

          return {
            ...conv,
            members: members || [],
            lastMessage: lastMsg?.[0] || null
          };
        })
      );

      // 3. Filtrer pour ne garder que celles o√π l'utilisateur est participant
      const userConversations = conversationsWithDetails.filter(conv =>
        conv.members.some(m => m.user_id === currentUser.id)
      );

      const list = document.getElementById('conversationsList');
      
      if (userConversations.length === 0) {
        list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucune conversation</div>';
        return;
      }

      list.innerHTML = userConversations.map(conv => {
        let name, preview;
        
        if (conv.is_group) {
          name = conv.name;
          preview = `üë• ${conv.members.length} membres`;
        } else {
          const otherMember = conv.members.find(m => m.user_id !== currentUser.id);
          name = otherMember?.user?.display_name || 'Utilisateur';
          preview = conv.lastMessage?.content?.substring(0, 30) || 'Aucun message';
        }

        const avatarText = name.charAt(0).toUpperCase();
        const avatarClass = conv.is_group ? 'group' : '';

        return `
          <div class="conversation-item" onclick="selectConversation('${conv.id}')">
            <div class="conversation-avatar ${avatarClass}">
              ${conv.is_group ? '<i class="fas fa-users"></i>' : avatarText}
            </div>
            <div class="conversation-info">
              <div class="conversation-name">${escapeHtml(name)}</div>
              <div class="conversation-preview">${escapeHtml(preview)}</div>
            </div>
          </div>
        `;
      }).join('');
    } catch (error) {
      console.error('Erreur:', error);
    }
  }

  async function selectConversation(convId) {
    try {
      currentConversation = convId;

      document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
      event.currentTarget.classList.add('active');

      const { data: conv } = await supabaseClient
        .from('conversations')
        .select(`
          *,
          members:conversation_members(user_id, user:user_profiles(id, display_name))
        `)
        .eq('id', convId)
        .single();

      if (conv.is_group) {
        document.getElementById('chatTitle').textContent = conv.name;
        document.getElementById('statusText').textContent = `${conv.members.length} membres`;
        document.getElementById('chatAvatar').textContent = 'üë•';
        document.getElementById('chatAvatar').className = 'avatar group';
        document.getElementById('infoBtn').style.display = 'block';
      } else {
        const otherMember = conv.members.find(m => m.user_id !== currentUser.id);
        document.getElementById('chatTitle').textContent = otherMember?.user?.display_name || 'Utilisateur';
        document.getElementById('statusText').textContent = 'En ligne';
        document.getElementById('chatAvatar').textContent = otherMember?.user?.display_name?.charAt(0).toUpperCase();
        document.getElementById('chatAvatar').className = 'avatar';
        document.getElementById('infoBtn').style.display = 'none';
      }

      document.getElementById('noConversationSelected').style.display = 'none';
      document.getElementById('chatWindow').style.display = 'flex';

      loadMessages();

      if (messageSubscription) {
        await messageSubscription.unsubscribe();
      }
      
      messageSubscription = supabaseClient
        .channel(`messages:${convId}`)
        .on('postgres_changes', 
          { event: 'INSERT', schema: 'public', table: 'messages', filter: `conversation_id=eq.${convId}` },
          () => loadMessages()
        )
        .on('postgres_changes',
          { event: 'DELETE', schema: 'public', table: 'messages', filter: `conversation_id=eq.${convId}` },
          () => loadMessages()
        )
        .on('postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'message_reactions', filter: `message_id=in.(SELECT id FROM messages WHERE conversation_id=eq.${convId})` },
          () => loadMessages()
        )
        .on('postgres_changes',
          { event: 'DELETE', schema: 'public', table: 'message_reactions', filter: `message_id=in.(SELECT id FROM messages WHERE conversation_id=eq.${convId})` },
          () => loadMessages()
        )
        .on('postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'typing_indicators', filter: `conversation_id=eq.${convId}` },
          () => showTypingIndicator()
        )
        .subscribe();
    } catch (error) {
      console.error('Erreur:', error);
    }
  }

  async function loadMessages() {
    try {
      const { data: messages } = await supabaseClient
        .from('messages')
        .select(`
          *,
          sender:user_profiles(id, display_name),
          reactions:message_reactions(id, user_id, emoji)
        `)
        .eq('conversation_id', currentConversation)
        .order('created_at', { ascending: true });

      const container = document.getElementById('messagesContainer');
      
      if (!messages) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = messages.map(msg => {
        const isOwn = msg.sender_id === currentUser.id;
        const groupReactions = {};
        
        msg.reactions.forEach(reaction => {
          if (!groupReactions[reaction.emoji]) groupReactions[reaction.emoji] = [];
          groupReactions[reaction.emoji].push(reaction.user_id);
        });

        const reactionsHtml = Object.entries(groupReactions).map(([emoji, users]) => `
          <div class="reaction" onclick="toggleReaction('${msg.id}', '${emoji}', event)">
            ${emoji} <span class="reaction-count">${users.length}</span>
          </div>
        `).join('');

        return `
          <div class="message-group ${isOwn ? 'own' : 'other'}">
            ${!isOwn ? `<div class="message-avatar">${msg.sender.display_name.charAt(0).toUpperCase()}</div>` : ''}
            <div class="message-bubble">
              ${!isOwn ? `<div class="message-sender">${escapeHtml(msg.sender.display_name)}</div>` : ''}
              <div style="display: flex; align-items: flex-start; gap: 8px;">
                <div class="message-content">
                  <div class="message-text">${escapeHtml(msg.content)}</div>
                  <div class="message-time">${new Date(msg.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</div>
                  ${reactionsHtml ? `<div class="message-reactions">${reactionsHtml}</div>` : ''}
                </div>
                <div class="message-actions">
                  ${isOwn ? `<button class="btn-action" onclick="deleteMessage('${msg.id}')">‚úï</button>` : ''}
                  <button class="btn-action" onclick="showReactionPicker('${msg.id}')" style="background: var(--primary);">üòä</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
      }, 0);
    } catch (error) {
      console.error('Erreur:', error);
    }
  }

  async function sendMessage() {
    const input = document.getElementById('messageInput');
    const content = input.value.trim();

    if (!content || !currentConversation) return;

    try {
      const { error } = await supabaseClient
        .from('messages')
        .insert([{
          conversation_id: currentConversation,
          sender_id: currentUser.id,
          content
        }]);

      if (error) throw error;

      input.value = '';
      clearTypingIndicator();
      await loadMessages();
    } catch (error) {
      console.error('Erreur:', error);
    }
  }

  async function deleteMessage(messageId) {
    if (!confirm('Supprimer ce message ?')) return;

    try {
      const { error } = await supabaseClient
        .from('messages')
        .delete()
        .eq('id', messageId);

      if (error) throw error;
      await loadMessages();
    } catch (error) {
      console.error('Erreur:', error);
    }
  }

  function showReactionPicker(messageId) {
    const picker = document.getElementById('emojiPicker');
    picker.style.position = 'fixed';
    picker.style.bottom = '80px';
    picker.style.right = '20px';
    picker.style.zIndex = '101';
    picker.classList.remove('hidden');
    picker.dataset.messageId = messageId;
  }

  function toggleEmojiPicker() {
    const picker = document.getElementById('emojiPicker');
    picker.classList.toggle('hidden');
  }

  async function addReaction(emoji) {
    const messageId = document.getElementById('emojiPicker').dataset.messageId;
    if (!messageId) return;

    try {
      const { data: existing } = await supabaseClient
        .from('message_reactions')
        .select('id')
        .eq('message_id', messageId)
        .eq('user_id', currentUser.id)
        .eq('emoji', emoji)
        .single();

      if (existing) {
        await supabaseClient
          .from('message_reactions')
          .delete()
          .eq('id', existing.id);
      } else {
        await supabaseClient
          .from('message_reactions')
          .insert([{
            message_id: messageId,
            user_id: currentUser.id,
            emoji
          }]);
      }

      await loadMessages();
    } catch (error) {
      console.error('Erreur:', error);
    }
  }

  async function toggleReaction(messageId, emoji, event) {
    event.preventDefault();
    event.stopPropagation();

    try {
      const { data: existing } = await supabaseClient
        .from('message_reactions')
        .select('id')
        .eq('message_id', messageId)
        .eq('user_id', currentUser.id)
        .eq('emoji', emoji)
        .single();

      if (existing) {
        await supabaseClient
          .from('message_reactions')
          .delete()
          .eq('id', existing.id);
      } else {
        await supabaseClient
          .from('message_reactions')
          .insert([{
            message_id: messageId,
            user_id: currentUser.id,
            emoji
          }]);
      }

      await loadMessages();
    } catch (error) {
      // Reaction n'existe pas, on l'ajoute
      try {
        await supabaseClient
          .from('message_reactions')
          .insert([{
            message_id: messageId,
            user_id: currentUser.id,
            emoji
          }]);
        await loadMessages();
      } catch (e) {
        console.error('Erreur:', e);
      }
    }
  }

  function onTyping() {
    clearTimeout(typingTimeout);

    supabaseClient
      .from('typing_indicators')
      .insert([{
        conversation_id: currentConversation,
        user_id: currentUser.id
      }])
      .then(() => {
        typingTimeout = setTimeout(() => {
          clearTypingIndicator();
        }, 3000);
      });
  }

  async function clearTypingIndicator() {
    try {
      await supabaseClient
        .from('typing_indicators')
        .delete()
        .eq('conversation_id', currentConversation)
        .eq('user_id', currentUser.id);
    } catch (error) {
      console.error('Erreur:', error);
    }
  }

  async function showTypingIndicator() {
    try {
      const { data: typing } = await supabaseClient
        .from('typing_indicators')
        .select('user:user_profiles(display_name)')
        .eq('conversation_id', currentConversation)
        .neq('user_id', currentUser.id);

      if (typing && typing.length > 0) {
        const typingUsers = typing.map(t => t.user.display_name).join(', ');
        const indicator = document.querySelector('.typing-indicator');
        
        if (!indicator) {
          const html = `
            <div class="typing-indicator">
              <span>${typingUsers} est en train d'√©crire</span>
              <div class="typing-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
              </div>
            </div>
          `;
          document.getElementById('messagesContainer').insertAdjacentHTML('beforeend', html);
        }
      }
    } catch (error) {
      console.error('Erreur:', error);
    }
  }

  async function createConversation() {
    const email = document.getElementById('recipientEmail').value.trim();

    if (!email) {
      showError('conversationError', 'Email requis');
      return;
    }

    if (email === currentUser.email) {
      showError('conversationError', 'Impossible de cr√©er une conversation avec soi-m√™me');
      return;
    }

    try {
      // 1. Trouver l'utilisateur par email
      const { data: recipient, error: recipientError } = await supabaseClient
        .from('user_profiles')
        .select('id')
        .eq('email', email)
        .single();

      if (recipientError || !recipient) {
        showError('conversationError', 'Utilisateur non trouv√©');
        return;
      }

      // 2. Cr√©er la conversation directement (sans v√©rifier les existantes)
      const { data: newConv, error: convError } = await supabaseClient
        .from('conversations')
        .insert([{
          is_group: false,
          created_by: currentUser.id
        }])
        .select();

      if (convError) throw convError;
      if (!newConv || !newConv[0]) throw new Error('Erreur cr√©ation conversation');

      // 3. Ajouter les 2 participants
      const { error: membersError } = await supabaseClient
        .from('conversation_members')
        .insert([
          { conversation_id: newConv[0].id, user_id: currentUser.id },
          { conversation_id: newConv[0].id, user_id: recipient.id }
        ]);

      if (membersError) throw membersError;

      // 4. Fermer le modal et recharger
      closeModal('newConversationModal');
      document.getElementById('recipientEmail').value = '';
      await loadConversations();
      
      // S√©lectionner la nouvelle conversation
      setTimeout(() => {
        selectConversation(newConv[0].id);
      }, 500);

    } catch (error) {
      console.error('Erreur compl√®te:', error);
      showError('conversationError', 'Erreur: ' + error.message);
    }
  }

  function addGroupMember() {
    const email = document.getElementById('memberEmail').value.trim();
    if (!email || email === currentUser.email) return;

    selectedMembers.push(email);
    document.getElementById('memberEmail').value = '';
    updateMembersList();
  }

  function updateMembersList() {
    const list = document.getElementById('membersList');
    list.innerHTML = selectedMembers.map((email, idx) => `
      <div class="member-item">
        <div class="member-avatar">${email.charAt(0).toUpperCase()}</div>
        <span>${escapeHtml(email)}</span>
        <button onclick="removeMember(${idx})" style="margin-left: auto; background: var(--danger); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
      </div>
    `).join('');
  }

  function removeMember(idx) {
    selectedMembers.splice(idx, 1);
    updateMembersList();
  }

  async function createGroup() {
    const name = document.getElementById('groupName').value.trim();

    if (!name) {
      showError('groupError', 'Nom du groupe requis');
      return;
    }

    if (selectedMembers.length === 0) {
      showError('groupError', 'Ajoutez au moins un membre');
      return;
    }

    try {
      // R√©cup√©rer les IDs des membres
      const { data: members, error: membersError } = await supabaseClient
        .from('user_profiles')
        .select('id, email')
        .in('email', [...selectedMembers, currentUser.email]);

      if (membersError) throw membersError;

      if (members.length !== selectedMembers.length + 1) {
        showError('groupError', 'Un ou plusieurs utilisateurs n\'existent pas');
        return;
      }

      const { data: newGroup, error: groupError } = await supabaseClient
        .from('conversations')
        .insert([{
          name,
          is_group: true,
          created_by: currentUser.id
        }])
        .select();

      if (groupError) throw groupError;

      const memberInserts = members.map(m => ({
        conversation_id: newGroup[0].id,
        user_id: m.id
      }));

      const { error: memberInsertError } = await supabaseClient
        .from('conversation_members')
        .insert(memberInserts);

      if (memberInsertError) throw memberInsertError;

      closeModal('newGroupModal');
      document.getElementById('groupName').value = '';
      selectedMembers = [];
      updateMembersList();
      await loadConversations();
      selectConversation(newGroup[0].id);
    } catch (error) {
      showError('groupError', error.message);
    }
  }

  async function showGroupInfo() {
    try {
      const { data: conv } = await supabaseClient
        .from('conversations')
        .select(`
          *,
          members:conversation_members(user_id, user:user_profiles(id, display_name, email))
        `)
        .eq('id', currentConversation)
        .single();

      const membersHtml = conv.members.map(m => `
        <div class="member-item">
          <div class="member-avatar">${m.user.display_name.charAt(0).toUpperCase()}</div>
          <div>
            <div>${escapeHtml(m.user.display_name)}</div>
            <small style="color: var(--text-secondary);">${escapeHtml(m.user.email)}</small>
          </div>
        </div>
      `).join('');

      document.getElementById('groupInfoTitle').textContent = conv.name;
      document.getElementById('groupInfoMembers').innerHTML = `
        <h3 style="margin-bottom: 12px; color: var(--text-secondary);">Membres (${conv.members.length})</h3>
        ${membersHtml}
      `;

      openModal('groupInfoModal');
    } catch (error) {
      console.error('Erreur:', error);
    }
  }

  function filterConversations() {
    const search = document.getElementById('searchConversations').value.toLowerCase();
    document.querySelectorAll('.conversation-item').forEach(item => {
      const name = item.querySelector('.conversation-name').textContent.toLowerCase();
      item.style.display = name.includes(search) ? 'flex' : 'none';
    });
  }

  function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
  }

  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
  }

  function showError(elementId, message) {
    const el = document.getElementById(elementId);
    el.innerHTML = `<div class="error-message">${message}</div>`;
  }

  function showSuccess(elementId, message) {
    const el = document.getElementById(elementId);
    el.innerHTML = `<div class="success-message">${message}</div>`;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Fermer emoji picker au clic dehors
  document.addEventListener('click', (e) => {
    const picker = document.getElementById('emojiPicker');
    if (!picker.contains(e.target) && e.target.id !== 'emojiBtn' && !e.target.closest('#emojiBtn')) {
      picker.classList.add('hidden');
    }
  });
</script>

</body>
</html>
